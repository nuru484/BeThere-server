generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

enum role {
  ADMIN
  USER
}

model User {
  id             Int     @id @default(autoincrement())
  firstName      String  @db.VarChar(255)
  lastName       String  @db.VarChar(255)
  password       String
  email          String  @unique
  profilePicture String? @db.VarChar(255)
  phone          String? @unique
  faceScan       Json?
  role           role    @default(USER)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  Attendance     Attendance[]
  passwordResets PasswordReset[]

  @@index([id])
  @@index([email])
  @@index([phone])
}

model PasswordReset {
  id        Int       @id @default(autoincrement())
  userId    Int
  tokenHash String    @unique
  expiresAt DateTime
  usedAt    DateTime?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([tokenHash])
  @@index([expiresAt])
}

model Event {
  id                 Int       @id @default(autoincrement())
  title              String
  description        String?
  startDate          DateTime // First occurrence start date
  endDate            DateTime? // Optional: when the occurrences end
  isRecurring        Boolean   @default(false)
  recurrenceInterval Int       @default(1) // Every X days/weeks (e.g., 3 for every 3 days)
  durationDays       Int       @default(1) // How many days each occurrence lasts
  startTime          String // When attendance opens (e.g., "06:00")
  endTime            String // When attendance closes (e.g., "19:30")
  archived           Boolean   @default(false) // Archive status

  location   Location @relation(fields: [locationId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  locationId Int
  type       String

  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  sessions  Session[]
}

model Session {
  id        Int      @id @default(autoincrement())
  eventId   Int
  startDate DateTime
  endDate   DateTime
  startTime DateTime
  endTime   DateTime

  event       Event        @relation(fields: [eventId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  attendances Attendance[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([eventId, startDate])
}

model Location {
  id        Int     @id @default(autoincrement())
  name      String
  latitude  Float
  longitude Float
  city      String?
  country   String?
  events    Event[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city])
  @@index([country])
  @@index([name])
  @@index([latitude, longitude])
}

enum AttendanceStatus {
  PRESENT
  LATE
  ABSENT
}

model Attendance {
  id           Int              @id @default(autoincrement())
  status       AttendanceStatus @default(ABSENT)
  userId       Int
  sessionId    Int
  checkInTime  DateTime
  checkOutTime DateTime?

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade, onUpdate: Cascade)
  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade, onUpdate: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, sessionId])
}
